<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calmind Consultation</title>
</head>
<body>
  <h1>Calmind Consultation Flow</h1>

  <!-- Login Section -->
  <section id="login-section">
    <h2>Login</h2>
    <label for="email">Email:</label>
    <input type="email" id="email" placeholder="Enter email">
    <br>
    <label for="password">Password:</label>
    <input type="password" id="password" placeholder="Enter password">
    <br>
    <button onclick="login()">Login</button>
  </section>

  <!-- Step 1: Select Doctor -->
  <section id="step1" style="display:none;">
    <h2>1. Select Doctor</h2>
    <div id="doctors-list"></div>
    <button onclick="loadDoctors()">Load Doctors</button>
    <br>
    <label for="doctor-id">Doctor ID:</label>
    <input type="number" id="doctor-id">
    <button onclick="selectDoctor()">Next</button>
  </section>

  <!-- Step 2: Schedule Appointment -->
  <section id="step2" style="display:none;">
    <h2>2. Schedule Appointment</h2>
    <label for="appointment-date">Date:</label>
    <input type="date" id="appointment-date">
    <br>
    <label for="appointment-time">Time:</label>
    <input type="time" id="appointment-time">
    <br>
    <button onclick="scheduleAppointment()">Next</button>
  </section>

  <!-- Step 3: Add Complaint -->
  <section id="step3" style="display:none;">
    <h2>3. Add Complaint</h2>
    <textarea id="complaint-message" placeholder="Describe your issue..."></textarea>
    <br>
    <button onclick="addComplaint()">Next</button>
  </section>

  <!-- Step 4: Payment -->
  <section id="step4" style="display:none;">
    <h2>4. Payment</h2>
    <label for="payment-amount">Amount:</label>
    <input type="number" id="payment-amount" placeholder="Enter amount">
    <br>
    <button onclick="makePayment()">Pay</button>
  </section>

  <!-- Step 5: Status -->
  <section id="step5" style="display:none;">
    <h2>5. Consultation Status</h2>
    <div id="consultation-status"></div>
    <button onclick="checkStatus()">Refresh Status</button>
  </section>

  <script>
    const BASE_URL = 'https://api.calmind.site';
    let token = null;
    let consultationId = null;

    // Login Function
    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      const response = await fetch(`${BASE_URL}/user/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      const data = await response.json();
      if (data.success) {
        token = data.token;
        alert('Login successful!');
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('step1').style.display = 'block';
      } else {
        alert('Login failed: ' + data.message);
      }
    }

    // Load Doctors
    async function loadDoctors() {
      const response = await fetch(`${BASE_URL}/user/doctors`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        }
      });

      const data = await response.json();
      const doctorsList = document.getElementById('doctors-list');
      doctorsList.innerHTML = '';
      data.forEach((doctor) => {
        doctorsList.innerHTML += `
          <div>
            <p>ID: ${doctor.id}</p>
            <p>Name: ${doctor.username}</p>
          </div>`;
      });
    }

    // Select Doctor
    function selectDoctor() {
      const doctorId = document.getElementById('doctor-id').value;
      if (!doctorId) {
        alert('Please select a doctor.');
        return;
      }

      document.getElementById('step1').style.display = 'none';
      document.getElementById('step2').style.display = 'block';
    }

    // Schedule Appointment
    async function scheduleAppointment() {
      const doctorId = document.getElementById('doctor-id').value;
      const date = document.getElementById('appointment-date').value;
      const time = document.getElementById('appointment-time').value;

      const response = await fetch(`${BASE_URL}/user/consultations/schedule`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({
          doctor_id: doctorId,
          date,
          time
        })
      });

      const data = await response.json();
      if (data.success) {
        consultationId = data.data.consultation_id;
        alert('Appointment scheduled successfully!');
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step3').style.display = 'block';
      } else {
        alert('Failed to schedule appointment: ' + data.message);
      }
    }

    // Add Complaint
    async function addComplaint() {
      const message = document.getElementById('complaint-message').value;

      const response = await fetch(`${BASE_URL}/user/consultations/${consultationId}/message`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ message })
      });

      const data = await response.json();
      if (data.success) {
        alert('Complaint added successfully!');
        document.getElementById('step3').style.display = 'none';
        document.getElementById('step4').style.display = 'block';
      } else {
        alert('Failed to add complaint: ' + data.message);
      }
    }

    // Make Payment
    async function makePayment() {
      const amount = document.getElementById('payment-amount').value;

      const response = await fetch(`${BASE_URL}/user/payments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({
          consultation_id: consultationId,
          amount
        })
      });

      const data = await response.json();
      if (data.success) {
        alert('Payment successful!');
        document.getElementById('step4').style.display = 'none';
        document.getElementById('step5').style.display = 'block';
        checkStatus();
      } else {
        alert('Payment failed: ' + data.message);
      }
    }

    // Check Status
    async function checkStatus() {
      const response = await fetch(`${BASE_URL}/user/consultations/${consultationId}/status`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        }
      });

      const data = await response.json();
      const statusDiv = document.getElementById('consultation-status');
      if (data.success) {
        statusDiv.innerHTML = `
          <p>Status: ${data.data.status}</p>
          <p>Recommendation: ${data.data.recommendation || 'No recommendation yet.'}</p>
        `;
      } else {
        statusDiv.innerHTML = '<p>Failed to fetch status.</p>';
      }
    }
  </script>
</body>
</html>
